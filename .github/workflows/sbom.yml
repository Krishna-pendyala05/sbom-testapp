name: SBOM & Vulnerability Reports (All Tools)

on:
  push:

jobs:
  sbom-and-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js (for cdxgen)
        uses: actions/setup-node@v3
        with:
          node-version: "18.x"

      # ---- cdxgen ----
      - name: "cdxgen: Record SBOM start"
        run: echo "CDX_SBOM_START=$(date +%s)" >> $GITHUB_ENV

      - name: "cdxgen: Install CLI & generate SBOM"
        run: |
          npm install -g @cyclonedx/cdxgen
          cdxgen -o sbom-cdxgen.json

      - name: "cdxgen: Record SBOM duration"
        run: |
          SBOM_END=$(date +%s)
          echo "cdxgen SBOM took $((SBOM_END - CDX_SBOM_START)) seconds"

      - name: "cdxgen: Record vuln-scan start"
        run: echo "CDX_SCAN_START=$(date +%s)" >> $GITHUB_ENV

      - name: "cdxgen: Scan SBOM"
        uses: anchore/scan-action@v6.1.0
        with:
          sbom: sbom-cdxgen.json
          output-format: json
          output-file: vuln-cdxgen.json
          fail-build: false

      - name: "cdxgen: Record vuln-scan duration"
        run: |
          SCAN_END=$(date +%s)
          echo "cdxgen vuln-scan took $((SCAN_END - CDX_SCAN_START)) seconds"

      # ---- Syft ----
      - name: "syft: Record SBOM start"
        run: echo "SYFT_SBOM_START=$(date +%s)" >> $GITHUB_ENV

      - name: "syft: Generate SBOM"
        uses: anchore/sbom-action@v0.18.0
        with:
          path: .
          format: json
          output-file: sbom-syft.json
          upload-artifact: false

      - name: "syft: Record SBOM duration"
        run: |
          SBOM_END=$(date +%s)
          echo "syft SBOM took $((SBOM_END - SYFT_SBOM_START)) seconds"

      - name: "syft: Record vuln-scan start"
        run: echo "SYFT_SCAN_START=$(date +%s)" >> $GITHUB_ENV

      - name: "syft: Scan SBOM"
        uses: anchore/scan-action@v6.1.0
        with:
          sbom: sbom-syft.json
          output-format: json
          output-file: vuln-syft.json
          fail-build: false

      - name: "syft: Record vuln-scan duration"
        run: |
          SCAN_END=$(date +%s)
          echo "syft vuln-scan took $((SCAN_END - SYFT_SCAN_START)) seconds"

      # ---- Trivy (FS SBOM) ----
      - name: "trivy: Record SBOM start"
        run: echo "TRIVY_SBOM_START=$(date +%s)" >> $GITHUB_ENV

      - name: "trivy: Install Trivy CLI"
        uses: aquasecurity/setup-trivy@ff1b8b060f23b650436d419b5e13f67f5d4c3087
        with:
          version: v0.60.1

      - name: "trivy: Generate FS-based CycloneDX SBOM"
        run: trivy fs --list-all-pkgs --format cyclonedx --output sbom-trivy.json .

      - name: "trivy: Record SBOM duration"
        run: |
          SBOM_END=$(date +%s)
          echo "trivy SBOM took $((SBOM_END - TRIVY_SBOM_START)) seconds"

      - name: "trivy: Record vuln-scan start"
        run: echo "TRIVY_SCAN_START=$(date +%s)" >> $GITHUB_ENV

      - name: "trivy: Scan SBOM"
        uses: anchore/scan-action@v6.1.0
        with:
          sbom: sbom-trivy.json
          output-format: json
          output-file: vuln-trivy.json
          fail-build: false

      - name: "trivy: Record vuln-scan duration"
        run: |
          SCAN_END=$(date +%s)
          echo "trivy vuln-scan took $((SCAN_END - TRIVY_SCAN_START)) seconds"

      # ---- Upload everything ----
      - name: Upload all SBOMs & vulnerability reports
        uses: actions/upload-artifact@v4
        with:
          name: all-sboms-and-vulns
          path: |
            sbom-cdxgen.json
            vuln-cdxgen.json
            sbom-syft.json
            vuln-syft.json
            sbom-trivy.json
            vuln-trivy.json
